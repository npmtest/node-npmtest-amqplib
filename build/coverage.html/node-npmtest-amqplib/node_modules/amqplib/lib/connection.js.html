<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for node-npmtest-amqplib/node_modules/amqplib/lib/connection.js</title>
    <meta charset="utf-8">
    <style>
        body, html {
            margin:0; padding: 0;
        }
        body {
            font-family: Arial, Helvetica;
            font-size: 10pt;
        }
        div.header, div.footer {
            background: #eee;
            padding: 1em;
        }
        div.header {
            height: 160px;
            padding: 0 1em 0 1em;
            z-index: 100;
            position: fixed;
            top: 0;
            border-bottom: 1px solid #666;
            width: 100%;
        }
        div.footer {
            border-top: 1px solid #666;
        }
        div.body {
            margin-top: 170px;
        }
        div.meta {
            font-size: 90%;
            text-align: center;
        }
        h1, h2, h3 {
            font-weight: normal;
        }
        h1 {
            font-size: 12pt;
        }
        h2 {
            font-size: 10pt;
        }
        pre {
            font-family: Menlo, Monaco, Consolas, Courier New, monospace;
            margin: 0;
            padding: 0;
            font-size: 14px;
            tab-size: 2;
        }

        div.path { font-size: 110%; }
        div.path a:link, div.path a:visited { color: #000; }
        table.coverage { border-collapse: collapse; margin:0; padding: 0 }

        table.coverage td {
            margin: 0;
            padding: 0;
            color: #111;
            vertical-align: top;
        }
        table.coverage td.line-count {
            width: 50px;
            text-align: right;
            padding-right: 5px;
        }
        table.coverage td.line-coverage {
            color: #777 !important;
            text-align: right;
            border-left: 1px solid #666;
            border-right: 1px solid #666;
        }

        table.coverage td.text {
        }

        table.coverage td span.cline-any {
            display: inline-block;
            padding: 0 5px;
            width: 40px;
        }
        table.coverage td span.cline-neutral {
            background: #eee;
        }
        table.coverage td span.cline-yes {
            background: #b5d592;
            color: #999;
        }
        table.coverage td span.cline-no {
            background: #fc8c84;
        }

        .cstat-yes { color: #111; }
        .cstat-no { background: #fc8c84; color: #111; }
        .fstat-no { background: #ffc520; color: #111 !important; }
        .cbranch-no { background:  yellow !important; color: #111; }

        .cstat-skip { background: #ddd; color: #111; }
        .fstat-skip { background: #ddd; color: #111 !important; }
        .cbranch-skip { background: #ddd !important; color: #111; }

        .missing-if-branch {
            display: inline-block;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: black;
            color: yellow;
        }

        .skip-if-branch {
            display: none;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: #ccc;
            color: white;
        }

        .missing-if-branch .typ, .skip-if-branch .typ {
            color: inherit !important;
        }

        .entity, .metric { font-weight: bold; }
        .metric { display: inline-block; border: 1px solid #333; padding: 0.3em; background: white; }
        .metric small { font-size: 80%; font-weight: normal; color: #666; }

        div.coverage-summary table { border-collapse: collapse; margin: 3em; font-size: 110%; }
        div.coverage-summary td, div.coverage-summary table  th { margin: 0; padding: 0.25em 1em; border-top: 1px solid #666; border-bottom: 1px solid #666; }
        div.coverage-summary th { text-align: left; border: 1px solid #666; background: #eee; font-weight: normal; }
        div.coverage-summary th.file { border-right: none !important; }
        div.coverage-summary th.pic { border-left: none !important; text-align: right; }
        div.coverage-summary th.pct { border-right: none !important; }
        div.coverage-summary th.abs { border-left: none !important; text-align: right; }
        div.coverage-summary td.pct { text-align: right; border-left: 1px solid #666; }
        div.coverage-summary td.abs { text-align: right; font-size: 90%; color: #444; border-right: 1px solid #666; }
        div.coverage-summary td.file { text-align: right; border-left: 1px solid #666; white-space: nowrap;  }
        div.coverage-summary td.pic { min-width: 120px !important;  }
        div.coverage-summary a:link { color: #000; }
        div.coverage-summary a:visited { color: #333; }
        div.coverage-summary tfoot td { border-top: 1px solid #666; }

        div.coverage-summary .yui3-datatable-sort-indicator, div.coverage-summary .dummy-sort-indicator {
            height: 10px;
            width: 7px;
            display: inline-block;
            margin-left: 0.5em;
        }
        div.coverage-summary .yui3-datatable-sort-indicator {
            background: no-repeat scroll 0 0 transparent;
        }
        div.coverage-summary .yui3-datatable-sorted .yui3-datatable-sort-indicator {
            background-position: 0 -20px;
        }
        div.coverage-summary .yui3-datatable-sorted-desc .yui3-datatable-sort-indicator {
            background-position: 0 -10px;
        }

        .high { background: #b5d592 !important; }
        .medium { background: #ffe87c !important; }
        .low { background: #fc8c84 !important; }

        span.cover-fill, span.cover-empty {
            display:inline-block;
            border:1px solid #444;
            background: white;
            height: 12px;
        }
        span.cover-fill {
            background: #ccc;
            border-right: 1px solid #444;
        }
        span.cover-empty {
            background: white;
            border-left: none;
        }
        span.cover-full {
            border-right: none !important;
        }
        pre.prettyprint {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .com { color: #999 !important; }
        .ignore-none { color: #999; font-weight: normal; }

    </style>
</head>
<body>
<div class="header low">
    <h1 style="font-weight: bold;">
        <a href="https://github.com/npmtest/node-npmtest-amqplib">npmtest-amqplib (v0.0.2)</a>
    </h1>
    <h1>Code coverage report for <span class="entity">node-npmtest-amqplib/node_modules/amqplib/lib/connection.js</span></h1>
    <h2>
        
        Statements: <span class="metric">22.22% <small>(70 / 315)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">2.13% <small>(2 / 94)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">0% <small>(0 / 53)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">23.1% <small>(70 / 303)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../../index.html">All files</a> &#187; <a href="index.html">node-npmtest-amqplib/node_modules/amqplib/lib/</a> &#187; connection.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
550
551
552
553
554
555
556
557
558
559
560
561
562
563
564
565
566
567
568
569
570
571
572
573
574
575
576
577
578
579
580
581
582
583
584
585
586
587
588
589
590
591
592
593
594
595
596
597
598
599
600
601
602
603
604
605
606
607
608
609
610
611
612
613
614
615
616
617
618
619
620
621
622
623
624
625
626
627
628
629
630
631
632
633
634
635
636
637
638
639
640
641
642
643
644
645
646
647</td><td class="line-coverage"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">//
//
//
&nbsp;
'use strict';
&nbsp;
var defs = require('./defs');
var constants = defs.constants;
var frame = require('./frame');
var HEARTBEAT = frame.HEARTBEAT;
var Mux = require('./mux').Mux;
&nbsp;
var Duplex =
  require('stream').Duplex ||
<span class="branch-1 cbranch-no" title="branch not covered" >  require('readable-stream/duplex');</span>
var EventEmitter = require('events').EventEmitter;
var Heart = require('./heartbeat').Heart;
&nbsp;
var methodName = require('./format').methodName;
var closeMsg = require('./format').closeMessage;
var inspect = require('./format').inspect;
&nbsp;
var BitSet = require('./bitset').BitSet;
var inherits = require('util').inherits;
var fmt = require('util').format;
var PassThrough = require('stream').PassThrough ||
<span class="branch-1 cbranch-no" title="branch not covered" >  require('readable-stream/passthrough');</span>
var IllegalOperationError = require('./error').IllegalOperationError;
var stackCapture = require('./error').stackCapture;
&nbsp;
// High-water mark for channel write buffers, in 'objects' (which are
// encoded frames as buffers).
var DEFAULT_WRITE_HWM = 1024;
// If all the frames of a message (method, properties, content) total
// to less than this, copy them into a single buffer and write it all
// at once. Note that this is less than the minimum frame size: if it
// was greater, we might have to fragment the content.
var SINGLE_CHUNK_THRESHOLD = 2048;
&nbsp;
<span class="fstat-no" title="function not covered" >function Connection(underlying) {</span>
<span class="cstat-no" title="statement not covered" >  EventEmitter.call( this );</span>
<span class="cstat-no" title="statement not covered" >  var stream = this.stream = wrapStream(underlying);</span>
<span class="cstat-no" title="statement not covered" >  this.muxer = new Mux(stream);</span>
&nbsp;
  // frames
<span class="cstat-no" title="statement not covered" >  this.rest = new Buffer(0);</span>
<span class="cstat-no" title="statement not covered" >  this.frameMax = constants.FRAME_MIN_SIZE;</span>
<span class="cstat-no" title="statement not covered" >  this.sentSinceLastCheck = false;</span>
<span class="cstat-no" title="statement not covered" >  this.recvSinceLastCheck = false;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  this.expectSocketClose = false;</span>
<span class="cstat-no" title="statement not covered" >  this.freeChannels = new BitSet();</span>
<span class="cstat-no" title="statement not covered" >  this.channels = [{channel: {accept: channel0(this)},</span>
                    buffer: underlying}];
}
inherits(Connection, EventEmitter);
&nbsp;
var C = Connection.prototype;
&nbsp;
// Usual frame accept mode
<span class="fstat-no" title="function not covered" >function mainAccept(frame) {</span>
<span class="cstat-no" title="statement not covered" >  var rec = this.channels[frame.channel];</span>
<span class="cstat-no" title="statement not covered" >  if (rec) { <span class="cstat-no" title="statement not covered" >return rec.channel.accept(frame); </span>}</span>
  // NB CHANNEL_ERROR may not be right, but I don't know what is ..
  else
<span class="cstat-no" title="statement not covered" >    this.closeWithError(</span>
      fmt('Frame on unknown channel %d', frame.channel),
      constants.CHANNEL_ERROR,
      new Error(fmt("Frame on unknown channel: %s",
                    inspect(frame, false))));
}
&nbsp;
// Handle anything that comes through on channel 0, that's the
// connection control channel. This is only used once mainAccept is
// installed as the frame handler, after the opening handshake.
<span class="fstat-no" title="function not covered" >function channel0(connection) {</span>
<span class="cstat-no" title="statement not covered" >  return <span class="fstat-no" title="function not covered" >function(f) {</span></span>
    // Once we get a 'close', we know 1. we'll get no more frames, and
    // 2. anything we send except close, or close-ok, will be
    // ignored. If we already sent 'close', this won't be invoked since
    // we're already in closing mode; if we didn't well we're not going
    // to send it now are we.
<span class="cstat-no" title="statement not covered" >    if (f === HEARTBEAT); // ignore; it's already counted as activity</span>
                          // on the socket, which is its purpose
    else <span class="cstat-no" title="statement not covered" >if (f.id === defs.ConnectionClose) {</span>
      // Oh. OK. I guess we're done here then.
<span class="cstat-no" title="statement not covered" >      connection.sendMethod(0, defs.ConnectionCloseOk, {});</span>
<span class="cstat-no" title="statement not covered" >      var emsg = fmt('Connection closed: %s', closeMsg(f));</span>
<span class="cstat-no" title="statement not covered" >      var s = stackCapture(emsg);</span>
<span class="cstat-no" title="statement not covered" >      var e = new Error(emsg);</span>
<span class="cstat-no" title="statement not covered" >      e.code = f.fields.replyCode;</span>
<span class="cstat-no" title="statement not covered" >      if (isFatalError(e)) {</span>
<span class="cstat-no" title="statement not covered" >        connection.emit('error', e);</span>
      }
<span class="cstat-no" title="statement not covered" >      connection.toClosed(s, e);</span>
    }
    else <span class="cstat-no" title="statement not covered" >if (f.id === defs.ConnectionBlocked) {</span>
<span class="cstat-no" title="statement not covered" >      connection.emit('blocked', f.fields.reason);</span>
    }
    else <span class="cstat-no" title="statement not covered" >if (f.id === defs.ConnectionUnblocked) {</span>
<span class="cstat-no" title="statement not covered" >      connection.emit('unblocked');</span>
    }
    else {
<span class="cstat-no" title="statement not covered" >      connection.closeWithError(</span>
        fmt("Unexpected frame on channel 0"),
        constants.UNEXPECTED_FRAME,
        new Error(fmt("Unexpected frame on channel 0: %s",
                      inspect(f, false))));
    }
  };
}
&nbsp;
// This changed between versions, as did the codec, methods, etc. AMQP
// 0-9-1 is fairly similar to 0.8, but better, and nothing implements
// 0.8 that doesn't implement 0-9-1. In other words, it doesn't make
// much sense to generalise here.
C.sendProtocolHeader = <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >  this.sendBytes(frame.PROTOCOL_HEADER);</span>
};
&nbsp;
/*
  The frighteningly complicated opening protocol (spec section 2.2.4):
&nbsp;
     Client -&gt; Server
&nbsp;
       protocol header -&gt;
         &lt;- start
       start-ok -&gt;
     .. next two zero or more times ..
         &lt;- secure
       secure-ok -&gt;
         &lt;- tune
       tune-ok -&gt;
       open -&gt;
         &lt;- open-ok
&nbsp;
If I'm only supporting SASL's PLAIN mechanism (which I am for the time
being), it gets a bit easier since the server won't in general send
back a `secure`, it'll just send `tune` after the `start-ok`.
(SASL PLAIN: http://tools.ietf.org/html/rfc4616)
&nbsp;
*/
&nbsp;
C.open = <span class="fstat-no" title="function not covered" >function(allFields, openCallback0) {</span>
<span class="cstat-no" title="statement not covered" >  var self = this;</span>
<span class="cstat-no" title="statement not covered" >  var openCallback = openCallback0 || <span class="fstat-no" title="function not covered" >function() {</span>};</span>
&nbsp;
  // This is where we'll put our negotiated values
<span class="cstat-no" title="statement not covered" >  var tunedOptions = Object.create(allFields);</span>
&nbsp;
<span class="fstat-no" title="function not covered" >  function wait(k) {</span>
<span class="cstat-no" title="statement not covered" >    self.step(<span class="fstat-no" title="function not covered" >function(err, frame) {</span></span>
<span class="cstat-no" title="statement not covered" >      if (err !== null) <span class="cstat-no" title="statement not covered" >bail(err);</span></span>
      else <span class="cstat-no" title="statement not covered" >if (frame.channel !== 0) {</span>
<span class="cstat-no" title="statement not covered" >        bail(new Error(</span>
          fmt("Frame on channel != 0 during handshake: %s",
              inspect(frame, false))));
      }
      else <span class="cstat-no" title="statement not covered" >k(frame);</span>
    });
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function expect(Method, k) {</span>
<span class="cstat-no" title="statement not covered" >    wait(<span class="fstat-no" title="function not covered" >function(frame) {</span></span>
<span class="cstat-no" title="statement not covered" >      if (frame.id === Method) <span class="cstat-no" title="statement not covered" >k(frame);</span></span>
      else {
<span class="cstat-no" title="statement not covered" >        bail(new Error(</span>
          fmt("Expected %s; got %s",
              methodName(Method), inspect(frame, false))));
      }
    });
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function bail(err) {</span>
<span class="cstat-no" title="statement not covered" >    openCallback(err);</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function send(Method) {</span>
    // This can throw an exception if there's some problem with the
    // options; e.g., something is a string instead of a number.
<span class="cstat-no" title="statement not covered" >    try { <span class="cstat-no" title="statement not covered" >self.sendMethod(0, Method, tunedOptions); </span>}</span>
    catch (err) { <span class="cstat-no" title="statement not covered" >bail(err); </span>}
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function negotiate(server, desired) {</span>
    // We get sent values for channelMax, frameMax and heartbeat,
    // which we may accept or lower (subject to a minimum for
    // frameMax, but we'll leave that to the server to enforce). In
    // all cases, `0` really means "no limit", or rather the highest
    // value in the encoding, e.g., unsigned short for channelMax.
<span class="cstat-no" title="statement not covered" >    if (server === 0 || desired === 0) {</span>
      // i.e., whichever places a limit, if either
<span class="cstat-no" title="statement not covered" >      return Math.max(server, desired);</span>
    }
    else {
<span class="cstat-no" title="statement not covered" >      return Math.min(server, desired);</span>
    }
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function onStart(start) {</span>
<span class="cstat-no" title="statement not covered" >    var mechanisms = start.fields.mechanisms.toString().split(' ');</span>
<span class="cstat-no" title="statement not covered" >    if (mechanisms.indexOf(allFields.mechanism) &lt; 0) {</span>
<span class="cstat-no" title="statement not covered" >      bail(new Error(fmt('SASL mechanism %s is not provided by the server',</span>
                         allFields.mechanism)));
<span class="cstat-no" title="statement not covered" >      return;</span>
    }
<span class="cstat-no" title="statement not covered" >    send(defs.ConnectionStartOk);</span>
<span class="cstat-no" title="statement not covered" >    wait(afterStartOk);</span>
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function afterStartOk(reply) {</span>
<span class="cstat-no" title="statement not covered" >    switch (reply.id) {</span>
    case defs.ConnectionSecure:
<span class="cstat-no" title="statement not covered" >      bail(new Error(</span>
        "Wasn't expecting to have to go through secure"));
<span class="cstat-no" title="statement not covered" >      break;</span>
    case defs.ConnectionClose:
<span class="cstat-no" title="statement not covered" >      bail(new Error(fmt("Handshake terminated by server: %s",</span>
                         closeMsg(reply))));
<span class="cstat-no" title="statement not covered" >      break;</span>
    case defs.ConnectionTune:
<span class="cstat-no" title="statement not covered" >      var fields = reply.fields;</span>
<span class="cstat-no" title="statement not covered" >      tunedOptions.frameMax =</span>
        negotiate(fields.frameMax, allFields.frameMax);
<span class="cstat-no" title="statement not covered" >      tunedOptions.channelMax =</span>
        negotiate(fields.channelMax, allFields.channelMax);
<span class="cstat-no" title="statement not covered" >      tunedOptions.heartbeat =</span>
        negotiate(fields.heartbeat, allFields.heartbeat);
<span class="cstat-no" title="statement not covered" >      send(defs.ConnectionTuneOk);</span>
<span class="cstat-no" title="statement not covered" >      send(defs.ConnectionOpen);</span>
<span class="cstat-no" title="statement not covered" >      expect(defs.ConnectionOpenOk, onOpenOk);</span>
<span class="cstat-no" title="statement not covered" >      break;</span>
    default:
<span class="cstat-no" title="statement not covered" >      bail(new Error(</span>
        fmt("Expected connection.secure, connection.close, " +
            "or connection.tune during handshake; got %s",
            inspect(reply, false))));
<span class="cstat-no" title="statement not covered" >      break;</span>
    }
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  function onOpenOk(openOk) {</span>
    // Impose the maximum of the encoded value, if the negotiated
    // value is zero, meaning "no, no limits"
<span class="cstat-no" title="statement not covered" >    self.channelMax = tunedOptions.channelMax || 0xffff;</span>
<span class="cstat-no" title="statement not covered" >    self.frameMax = tunedOptions.frameMax || 0xffffffff;</span>
    // 0 means "no heartbeat", rather than "maximum period of
    // heartbeating"
<span class="cstat-no" title="statement not covered" >    self.heartbeat = tunedOptions.heartbeat;</span>
<span class="cstat-no" title="statement not covered" >    self.heartbeater = self.startHeartbeater();</span>
<span class="cstat-no" title="statement not covered" >    self.accept = mainAccept;</span>
<span class="cstat-no" title="statement not covered" >    succeed(openOk);</span>
  }
&nbsp;
  // If the server closes the connection, it's probably because of
  // something we did
<span class="fstat-no" title="function not covered" >  function endWhileOpening(err) {</span>
<span class="cstat-no" title="statement not covered" >    bail(err || new Error('Socket closed abruptly ' +</span>
                          'during opening handshake'));
  }
&nbsp;
<span class="cstat-no" title="statement not covered" >  this.stream.on('end', endWhileOpening);</span>
<span class="cstat-no" title="statement not covered" >  this.stream.on('error', endWhileOpening);</span>
&nbsp;
<span class="fstat-no" title="function not covered" >  function succeed(ok) {</span>
<span class="cstat-no" title="statement not covered" >    self.stream.removeListener('end', endWhileOpening);</span>
<span class="cstat-no" title="statement not covered" >    self.stream.removeListener('error', endWhileOpening);</span>
<span class="cstat-no" title="statement not covered" >    self.stream.on('error', self.onSocketError.bind(self));</span>
<span class="cstat-no" title="statement not covered" >    self.stream.on('end', self.onSocketError.bind(</span>
      self, new Error('Unexpected close')));
<span class="cstat-no" title="statement not covered" >    self.on('frameError', self.onSocketError.bind(self));</span>
<span class="cstat-no" title="statement not covered" >    self.acceptLoop();</span>
<span class="cstat-no" title="statement not covered" >    openCallback(null, ok);</span>
  }
&nbsp;
  // Now kick off the handshake by prompting the server
<span class="cstat-no" title="statement not covered" >  this.sendProtocolHeader();</span>
<span class="cstat-no" title="statement not covered" >  expect(defs.ConnectionStart, onStart);</span>
};
&nbsp;
// Closing things: AMQP has a closing handshake that applies to
// closing both connects and channels. As the initiating party, I send
// Close, then ignore all frames until I see either CloseOK --
// which signifies that the other party has seen the Close and shut
// the connection or channel down, so it's fine to free resources; or
// Close, which means the other party also wanted to close the
// whatever, and I should send CloseOk so it can free resources,
// then go back to waiting for the CloseOk. If I receive a Close
// out of the blue, I should throw away any unsent frames (they will
// be ignored anyway) and send CloseOk, then clean up resources. In
// general, Close out of the blue signals an error (or a forced
// closure, which may as well be an error).
//
//  RUNNING [1] --- send Close ---&gt; Closing [2] ---&gt; recv Close --+
//     |                               |                         [3]
//     |                               +------ send CloseOk ------+
//  recv Close                   recv CloseOk
//     |                               |
//     V                               V
//  Ended [4] ---- send CloseOk ---&gt; Closed [5]
//
// [1] All frames accepted; getting a Close frame from the server
// moves to Ended; client may initiate a close by sending Close
// itself.
// [2] Client has initiated a close; only CloseOk or (simulataneously
// sent) Close is accepted.
// [3] Simultaneous close
// [4] Server won't send any more frames; accept no more frames, send
// CloseOk.
// [5] Fully closed, client will send no more, server will send no
// more. Signal 'close' or 'error'.
//
// There are two signalling mechanisms used in the API. The first is
// that calling `close` will return a promise, that will either
// resolve once the connection or channel is cleanly shut down, or
// will reject if the shutdown times out.
//
// The second is the 'close' and 'error' events. These are
// emitted as above. The events will fire *before* promises are
// resolved.
&nbsp;
// Close the connection without even giving a reason. Typical.
C.close = <span class="fstat-no" title="function not covered" >function(closeCallback) {</span>
<span class="cstat-no" title="statement not covered" >  var k = closeCallback &amp;&amp; <span class="fstat-no" title="function not covered" >function() {</span> <span class="cstat-no" title="statement not covered" >closeCallback(null); </span>};</span>
<span class="cstat-no" title="statement not covered" >  this.closeBecause("Cheers, thanks", constants.REPLY_SUCCESS, k);</span>
};
&nbsp;
// Close with a reason and a 'code'. I'm pretty sure RabbitMQ totally
// ignores these; maybe it logs them. The continuation will be invoked
// when the CloseOk has been received, and before the 'close' event.
C.closeBecause = <span class="fstat-no" title="function not covered" >function(reason, code, k) {</span>
<span class="cstat-no" title="statement not covered" >  this.sendMethod(0, defs.ConnectionClose, {</span>
    replyText: reason,
    replyCode: code,
    methodId: 0, classId: 0
  });
<span class="cstat-no" title="statement not covered" >  var s = stackCapture('closeBecause called: ' + reason);</span>
<span class="cstat-no" title="statement not covered" >  this.toClosing(s, k);</span>
};
&nbsp;
C.closeWithError = <span class="fstat-no" title="function not covered" >function(reason, code, error) {</span>
<span class="cstat-no" title="statement not covered" >  this.emit('error', error);</span>
<span class="cstat-no" title="statement not covered" >  this.closeBecause(reason, code);</span>
};
&nbsp;
C.onSocketError = <span class="fstat-no" title="function not covered" >function(err) {</span>
<span class="cstat-no" title="statement not covered" >  if (!this.expectSocketClose) {</span>
    // forestall any more calls to onSocketError, since we're signed
    // up for `'error'` *and* `'end'`
<span class="cstat-no" title="statement not covered" >    this.expectSocketClose = true;</span>
<span class="cstat-no" title="statement not covered" >    this.emit('error', err);</span>
<span class="cstat-no" title="statement not covered" >    var s = stackCapture('Socket error');</span>
<span class="cstat-no" title="statement not covered" >    this.toClosed(s, err);</span>
  }
};
&nbsp;
<span class="fstat-no" title="function not covered" >function invalidOp(msg, stack) {</span>
<span class="cstat-no" title="statement not covered" >  return <span class="fstat-no" title="function not covered" >function() {</span></span>
<span class="cstat-no" title="statement not covered" >    throw new IllegalOperationError(msg, stack);</span>
  };
}
&nbsp;
<span class="fstat-no" title="function not covered" >function invalidateSend(conn, msg, stack) {</span>
<span class="cstat-no" title="statement not covered" >  conn.sendMethod = conn.sendContent = conn.sendMessage =</span>
    invalidOp(msg, stack);
}
&nbsp;
// A close has been initiated. Repeat: a close has been initiated.
// This means we should not send more frames, anyway they will be
// ignored. We also have to shut down all the channels.
C.toClosing = <span class="fstat-no" title="function not covered" >function(capturedStack, k) {</span>
<span class="cstat-no" title="statement not covered" >  var send = this.sendMethod.bind(this);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  this.accept = <span class="fstat-no" title="function not covered" >function(f) {</span></span>
<span class="cstat-no" title="statement not covered" >    if (f.id === defs.ConnectionCloseOk) {</span>
<span class="cstat-no" title="statement not covered" >      if (k) <span class="cstat-no" title="statement not covered" >k();</span></span>
<span class="cstat-no" title="statement not covered" >      var s = stackCapture('ConnectionCloseOk received');</span>
<span class="cstat-no" title="statement not covered" >      this.toClosed(s, undefined);</span>
    }
    else <span class="cstat-no" title="statement not covered" >if (f.id === defs.ConnectionClose) {</span>
<span class="cstat-no" title="statement not covered" >      send(0, defs.ConnectionCloseOk, {});</span>
    }
    // else ignore frame
  };
<span class="cstat-no" title="statement not covered" >  invalidateSend(this, 'Connection closing', capturedStack);</span>
};
&nbsp;
C._closeChannels = <span class="fstat-no" title="function not covered" >function(capturedStack) {</span>
<span class="cstat-no" title="statement not covered" >  for (var i = 1; i &lt; this.channels.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >    var ch = this.channels[i];</span>
<span class="cstat-no" title="statement not covered" >    if (ch !== null) {</span>
<span class="cstat-no" title="statement not covered" >      ch.channel.toClosed(capturedStack); </span>// %%% or with an error? not clear
    }
  }
};
&nbsp;
// A close has been confirmed. Cease all communication.
C.toClosed = <span class="fstat-no" title="function not covered" >function(capturedStack, maybeErr) {</span>
<span class="cstat-no" title="statement not covered" >  this._closeChannels(capturedStack);</span>
<span class="cstat-no" title="statement not covered" >  var info = fmt('Connection closed (%s)',</span>
                 (maybeErr) ? maybeErr.toString() : 'by client');
  // Tidy up, invalidate enverything, dynamite the bridges.
<span class="cstat-no" title="statement not covered" >  invalidateSend(this, info, capturedStack);</span>
<span class="cstat-no" title="statement not covered" >  this.accept = invalidOp(info, capturedStack);</span>
<span class="cstat-no" title="statement not covered" >  this.close = <span class="fstat-no" title="function not covered" >function(cb) {</span></span>
<span class="cstat-no" title="statement not covered" >    cb &amp;&amp; cb(new IllegalOperationError(info, capturedStack));</span>
  };
<span class="cstat-no" title="statement not covered" >  if (this.heartbeater) <span class="cstat-no" title="statement not covered" >this.heartbeater.clear();</span></span>
  // This is certainly true now, if it wasn't before
<span class="cstat-no" title="statement not covered" >  this.expectSocketClose = true;</span>
<span class="cstat-no" title="statement not covered" >  this.stream.end();</span>
<span class="cstat-no" title="statement not covered" >  this.emit('close', maybeErr);</span>
};
&nbsp;
// ===
&nbsp;
C.startHeartbeater = <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >  if (this.heartbeat === 0) <span class="cstat-no" title="statement not covered" >return null;</span></span>
  else {
<span class="cstat-no" title="statement not covered" >    var self = this;</span>
<span class="cstat-no" title="statement not covered" >    var hb = new Heart(this.heartbeat,</span>
                       this.checkSend.bind(this),
                       this.checkRecv.bind(this));
<span class="cstat-no" title="statement not covered" >    hb.on('timeout', <span class="fstat-no" title="function not covered" >function() {</span></span>
<span class="cstat-no" title="statement not covered" >      var hberr = new Error("Heartbeat timeout");</span>
<span class="cstat-no" title="statement not covered" >      self.emit('error', hberr);</span>
<span class="cstat-no" title="statement not covered" >      var s = stackCapture('Heartbeat timeout');</span>
<span class="cstat-no" title="statement not covered" >      self.toClosed(s, hberr);</span>
    });
<span class="cstat-no" title="statement not covered" >    hb.on('beat', <span class="fstat-no" title="function not covered" >function() {</span></span>
<span class="cstat-no" title="statement not covered" >      self.sendHeartbeat();</span>
    });
<span class="cstat-no" title="statement not covered" >    return hb;</span>
  }
};
&nbsp;
// I use an array to keep track of the channels, rather than an
// object. The channel identifiers are numbers, and allocated by the
// connection. If I try to allocate low numbers when they are
// available (which I do, by looking from the start of the bitset),
// this ought to keep the array small, and out of 'sparse array
// storage'. I also set entries to null, rather than deleting them, in
// the expectation that the next channel allocation will fill the slot
// again rather than growing the array. See
// http://www.html5rocks.com/en/tutorials/speed/v8/
C.freshChannel = <span class="fstat-no" title="function not covered" >function(channel, options) {</span>
<span class="cstat-no" title="statement not covered" >  var next = this.freeChannels.nextClearBit(1);</span>
<span class="cstat-no" title="statement not covered" >  if (next &lt; 0 || next &gt; this.channelMax)</span>
<span class="cstat-no" title="statement not covered" >    throw new Error("No channels left to allocate");</span>
<span class="cstat-no" title="statement not covered" >  this.freeChannels.set(next);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  var hwm = (options &amp;&amp; options.highWaterMark) || DEFAULT_WRITE_HWM;</span>
<span class="cstat-no" title="statement not covered" >  var writeBuffer = new PassThrough({</span>
    objectMode: true, highWaterMark: hwm
  });
<span class="cstat-no" title="statement not covered" >  this.channels[next] = {channel: channel, buffer: writeBuffer};</span>
<span class="cstat-no" title="statement not covered" >  writeBuffer.on('drain', <span class="fstat-no" title="function not covered" >function() {</span></span>
<span class="cstat-no" title="statement not covered" >    channel.onBufferDrain();</span>
  });
<span class="cstat-no" title="statement not covered" >  this.muxer.pipeFrom(writeBuffer);</span>
<span class="cstat-no" title="statement not covered" >  return next;</span>
};
&nbsp;
C.releaseChannel = <span class="fstat-no" title="function not covered" >function(channel) {</span>
<span class="cstat-no" title="statement not covered" >  this.freeChannels.clear(channel);</span>
<span class="cstat-no" title="statement not covered" >  var buffer = this.channels[channel].buffer;</span>
<span class="cstat-no" title="statement not covered" >  this.muxer.unpipeFrom(buffer);</span>
<span class="cstat-no" title="statement not covered" >  this.channels[channel] = null;</span>
};
&nbsp;
C.acceptLoop = <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >  var self = this;</span>
&nbsp;
<span class="fstat-no" title="function not covered" >  function go() {</span>
<span class="cstat-no" title="statement not covered" >    try {</span>
<span class="cstat-no" title="statement not covered" >      var f; <span class="cstat-no" title="statement not covered" ></span>while (f = self.recvFrame()) <span class="cstat-no" title="statement not covered" >self.accept(f);</span></span>
    }
    catch (e) {
<span class="cstat-no" title="statement not covered" >      self.emit('frameError', e);</span>
    }
  }
<span class="cstat-no" title="statement not covered" >  self.stream.on('readable', go);</span>
<span class="cstat-no" title="statement not covered" >  go();</span>
};
&nbsp;
C.step = <span class="fstat-no" title="function not covered" >function(cb) {</span>
<span class="cstat-no" title="statement not covered" >  var self = this;</span>
<span class="fstat-no" title="function not covered" >  function recv() {</span>
<span class="cstat-no" title="statement not covered" >    var f;</span>
<span class="cstat-no" title="statement not covered" >    try {</span>
<span class="cstat-no" title="statement not covered" >      f = self.recvFrame();</span>
    }
    catch (e) {
<span class="cstat-no" title="statement not covered" >      cb(e, null);</span>
<span class="cstat-no" title="statement not covered" >      return;</span>
    }
<span class="cstat-no" title="statement not covered" >    if (f) <span class="cstat-no" title="statement not covered" >cb(null, f);</span></span>
    else <span class="cstat-no" title="statement not covered" >self.stream.once('readable', recv);</span>
  }
<span class="cstat-no" title="statement not covered" >  recv();</span>
};
&nbsp;
C.checkSend = <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >  var check = this.sentSinceLastCheck;</span>
<span class="cstat-no" title="statement not covered" >  this.sentSinceLastCheck = false;</span>
<span class="cstat-no" title="statement not covered" >  return check;</span>
}
&nbsp;
C.checkRecv = <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >  var check = this.recvSinceLastCheck;</span>
<span class="cstat-no" title="statement not covered" >  this.recvSinceLastCheck = false;</span>
<span class="cstat-no" title="statement not covered" >  return check;</span>
}
&nbsp;
C.sendBytes = <span class="fstat-no" title="function not covered" >function(bytes) {</span>
<span class="cstat-no" title="statement not covered" >  this.sentSinceLastCheck = true;</span>
<span class="cstat-no" title="statement not covered" >  this.stream.write(bytes);</span>
};
&nbsp;
C.sendHeartbeat = <span class="fstat-no" title="function not covered" >function() {</span>
<span class="cstat-no" title="statement not covered" >  return this.sendBytes(frame.HEARTBEAT_BUF);</span>
};
&nbsp;
var encodeMethod = defs.encodeMethod;
var encodeProperties = defs.encodeProperties;
&nbsp;
C.sendMethod = <span class="fstat-no" title="function not covered" >function(channel, Method, fields) {</span>
<span class="cstat-no" title="statement not covered" >  var frame = encodeMethod(Method, channel, fields);</span>
<span class="cstat-no" title="statement not covered" >  this.sentSinceLastCheck = true;</span>
<span class="cstat-no" title="statement not covered" >  var buffer = this.channels[channel].buffer;</span>
<span class="cstat-no" title="statement not covered" >  return buffer.write(frame);</span>
};
&nbsp;
C.sendMessage = <span class="fstat-no" title="function not covered" >function(channel,</span>
                         Method, fields,
                         Properties, props,
                         content) {
<span class="cstat-no" title="statement not covered" >  if (!Buffer.isBuffer(content))</span>
<span class="cstat-no" title="statement not covered" >    throw new TypeError('content is not a buffer');</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  var mframe = encodeMethod(Method, channel, fields);</span>
<span class="cstat-no" title="statement not covered" >  var pframe = encodeProperties(Properties, channel,</span>
                                content.length, props);
<span class="cstat-no" title="statement not covered" >  var buffer = this.channels[channel].buffer;</span>
<span class="cstat-no" title="statement not covered" >  this.sentSinceLastCheck = true;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  var methodHeaderLen = mframe.length + pframe.length;</span>
<span class="cstat-no" title="statement not covered" >  var bodyLen = (content.length &gt; 0) ?</span>
    content.length + FRAME_OVERHEAD : 0;
<span class="cstat-no" title="statement not covered" >  var allLen = methodHeaderLen + bodyLen;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (allLen &lt; SINGLE_CHUNK_THRESHOLD) {</span>
<span class="cstat-no" title="statement not covered" >    var all = new Buffer(allLen);</span>
<span class="cstat-no" title="statement not covered" >    var offset = mframe.copy(all, 0);</span>
<span class="cstat-no" title="statement not covered" >    offset += pframe.copy(all, offset);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (bodyLen &gt; 0)</span>
<span class="cstat-no" title="statement not covered" >      makeBodyFrame(channel, content).copy(all, offset);</span>
<span class="cstat-no" title="statement not covered" >    return buffer.write(all);</span>
  }
  else {
<span class="cstat-no" title="statement not covered" >    if (methodHeaderLen &lt; SINGLE_CHUNK_THRESHOLD) {</span>
<span class="cstat-no" title="statement not covered" >      var both = new Buffer(methodHeaderLen);</span>
<span class="cstat-no" title="statement not covered" >      var offset = mframe.copy(both, 0);</span>
<span class="cstat-no" title="statement not covered" >      pframe.copy(both, offset);</span>
<span class="cstat-no" title="statement not covered" >      buffer.write(both);</span>
    }
    else {
<span class="cstat-no" title="statement not covered" >      buffer.write(mframe);</span>
<span class="cstat-no" title="statement not covered" >      buffer.write(pframe);</span>
    }
<span class="cstat-no" title="statement not covered" >    return this.sendContent(channel, content);</span>
  }
};
&nbsp;
var FRAME_OVERHEAD = defs.FRAME_OVERHEAD;
var makeBodyFrame = frame.makeBodyFrame;
&nbsp;
C.sendContent = <span class="fstat-no" title="function not covered" >function(channel, body) {</span>
<span class="cstat-no" title="statement not covered" >  if (!Buffer.isBuffer(body)) {</span>
<span class="cstat-no" title="statement not covered" >    throw new TypeError(fmt("Expected buffer; got %s", body));</span>
  }
<span class="cstat-no" title="statement not covered" >  var writeResult = true;</span>
<span class="cstat-no" title="statement not covered" >  var buffer = this.channels[channel].buffer;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  var maxBody = this.frameMax - FRAME_OVERHEAD;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  for (var offset = 0; offset &lt; body.length; offset += maxBody) {</span>
<span class="cstat-no" title="statement not covered" >    var end = offset + maxBody;</span>
<span class="cstat-no" title="statement not covered" >    var slice = (end &gt; body.length) ? body.slice(offset) : body.slice(offset, end);</span>
<span class="cstat-no" title="statement not covered" >    var bodyFrame = makeBodyFrame(channel, slice);</span>
<span class="cstat-no" title="statement not covered" >    writeResult = buffer.write(bodyFrame);</span>
  }
<span class="cstat-no" title="statement not covered" >  this.sentSinceLastCheck = true;</span>
<span class="cstat-no" title="statement not covered" >  return writeResult;</span>
};
&nbsp;
var parseFrame = frame.parseFrame;
var decodeFrame = frame.decodeFrame;
&nbsp;
C.recvFrame = <span class="fstat-no" title="function not covered" >function() {</span>
  // %%% identifying invariants might help here?
<span class="cstat-no" title="statement not covered" >  var frame = parseFrame(this.rest, this.frameMax);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >  if (!frame) {</span>
<span class="cstat-no" title="statement not covered" >    var incoming = this.stream.read();</span>
<span class="cstat-no" title="statement not covered" >    if (incoming === null) {</span>
<span class="cstat-no" title="statement not covered" >      return false;</span>
    }
    else {
<span class="cstat-no" title="statement not covered" >      this.recvSinceLastCheck = true;</span>
<span class="cstat-no" title="statement not covered" >      this.rest = Buffer.concat([this.rest, incoming]);</span>
<span class="cstat-no" title="statement not covered" >      return this.recvFrame();</span>
    }
  }
  else {
<span class="cstat-no" title="statement not covered" >    this.rest = frame.rest;</span>
<span class="cstat-no" title="statement not covered" >    return decodeFrame(frame);</span>
  }
};
&nbsp;
<span class="fstat-no" title="function not covered" >function wrapStream(s) {</span>
<span class="cstat-no" title="statement not covered" >  if (s instanceof Duplex) <span class="cstat-no" title="statement not covered" >return s;</span></span>
  else {
<span class="cstat-no" title="statement not covered" >    var ws = new Duplex();</span>
<span class="cstat-no" title="statement not covered" >    ws.wrap(s); </span>//wraps the readable side of things
<span class="cstat-no" title="statement not covered" >    ws._write = <span class="fstat-no" title="function not covered" >function(chunk, encoding, callback) {</span></span>
<span class="cstat-no" title="statement not covered" >      return s.write(chunk, encoding, callback);</span>
    };
<span class="cstat-no" title="statement not covered" >    return ws;</span>
  }
}
&nbsp;
<span class="fstat-no" title="function not covered" >function isFatalError(error) {</span>
<span class="cstat-no" title="statement not covered" >  switch (error &amp;&amp; error.code) {</span>
  case defs.constants.CONNECTION_FORCED:
  case defs.constants.REPLY_SUCCESS:
<span class="cstat-no" title="statement not covered" >    return false;</span>
  default:
<span class="cstat-no" title="statement not covered" >    return true;</span>
  }
}
&nbsp;
module.exports.Connection = Connection;
module.exports.isFatalError = isFatalError;
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
</div>
<div class="footer">
    <div class="meta">Generated by <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a> at Sat Apr 22 2017 10:03:48 GMT+0000 (UTC)</div>
</div>
</body>
</html>
